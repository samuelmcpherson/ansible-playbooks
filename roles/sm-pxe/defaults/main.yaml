---
### Requires docker task

- name: pxe-boot setup
  hosts: pxe-boot
  become: true
  
  pre_tasks:
    - name: update repositories
      apt: 
        update_cache: yes
        upgrade: safe
      changed_when: False
    
    - name: install and setup docker
      include_tasks: "{{ root_of_repo }}/roles/sm-docker/tasks/install-docker.yaml"
  
  tasks:
    - name: pull compose files from pxe-boot repo
      git:
        clone: yes
        dest: /srv/pxe-boot
        repo: https://github.com/samuelmcpherson/pxe-boot.git

    - name: start docker-compose stack for nginx container serving installer preseed
      docker_compose:
        project_src: /srv/pxe-boot/nginx-preseed
        state: present
        restarted: yes

    - name: start docker-compose stack for tftp container serving tftp pxe boot environment
      docker_compose:
        project_src: /srv/pxe-boot/tftp-pxe
        state: present
        restarted: yes






#    - name: install TFTP server
#      apt:  
#        name: 
#          - tftpd-hpa
#        state: latest

#    - name: Install default config
#      copy:
#        src: "{{ root_of_repo }}/files/pxe-tftp/tftpd-hpa"
#        dest: /etc/default/tftpd-hpa
#        owner: root
#        group: root
#        mode: '0644'

#    - name: Restart service
#      systemd:
#        name: tftpd-hpa.service
#        enabled: yes
#        state: restarted